<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Diagnostic √©nerg√©tique des b√¢timents</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.css" rel="stylesheet"/>

<style>
:root{
  --accent:#1e8e6a;
  --accent2:#1b6eea;
  --panel:rgba(255,255,255,.9);
  --stroke:rgba(0,0,0,.12);
}
html,body{margin:0;height:100%;font-family:system-ui}
#map{position:absolute;inset:0}

/* BARRE */
.topbar{
position:absolute;top:14px;left:50%;transform:translateX(-50%);
width:min(900px,calc(100% - 24px));
background:var(--panel);
border-radius:16px;
padding:10px 14px;
display:flex;justify-content:space-between;align-items:center;
box-shadow:0 10px 35px rgba(0,0,0,.15);
z-index:5;
}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:36px;height:36px;background:linear-gradient(135deg,#1e8e6a,#1b6eea);border-radius:10px;display:grid;place-items:center;color:#fff;font-weight:bold}
.kicker{font-size:12px;color:#666}
h1{font-size:15px;margin:0}

.btn{
background:#e8f3ef;border:1px solid var(--stroke);
padding:7px 10px;border-radius:12px;font-weight:600;cursor:pointer
}

/* LEGENDE */
.legend{
position:absolute;bottom:16px;left:16px;
background:var(--panel);
padding:12px;border-radius:14px;
box-shadow:0 8px 30px rgba(0,0,0,.15);
z-index:5;
}
.dot{width:10px;height:10px;background:#d32f2f;border-radius:50%;display:inline-block;margin-right:6px}

/* POPUP */
.mapboxgl-popup{max-width:240px!important}
.popup-mini h3{margin:0;font-size:14px}
.popup-mini img{width:100%;height:120px;object-fit:cover;border-radius:10px;margin-top:6px}
.popup-mini a{display:inline-block;margin-top:6px;font-size:12px;color:#1b6eea;text-decoration:none}

/* NORD */
.north{
position:absolute;right:16px;bottom:16px;
background:white;padding:8px;border-radius:12px;
box-shadow:0 5px 20px rgba(0,0,0,.2);
font-weight:bold;z-index:5;
}

/* DRAWER */
.drawer{position:absolute;inset:0;display:none;z-index:20}
.drawer.open{display:block}
.drawer-card{
position:absolute;right:0;top:0;height:100%;width:min(720px,100%);
background:white;box-shadow:-10px 0 40px rgba(0,0,0,.25);
display:flex;flex-direction:column;
}
.drawer-head{padding:14px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between}
.list button{display:block;width:100%;padding:8px;border:none;background:#f4f4f4;margin-bottom:6px;border-radius:8px;cursor:pointer}
iframe{flex:1;border:none}
</style>
</head>

<body>

<div class="topbar">
<div class="brand">
<div class="logo">‚ö°</div>
<div>
<div class="kicker">H√©rault √ânergie ‚Ä¢ Chef de projet : Fr√©d√©ric Lamur</div>
<h1>Diagnostic √©nerg√©tique des b√¢timents</h1>
</div>
</div>
<button class="btn" id="openBilans">Bilans communaux</button>
</div>

<div id="map"></div>

<div class="legend">
<div><span class="dot"></span>B√¢timent diagnostiqu√©</div>
<div style="font-size:12px;color:#666">Clique sur un point</div>
</div>

<div class="north">N ‚Üë</div>

<!-- DRAWER -->
<div class="drawer" id="drawer">
<div class="drawer-card">
<div class="drawer-head">
<b>Bilans communaux</b>
<button id="closeDrawer">‚úï</button>
</div>
<div class="list" id="bilansList"></div>
<iframe id="pdfFrame"></iframe>
</div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.js"></script>

<script>
mapboxgl.accessToken="pk.eyJ1IjoibmluYW5vdW4iLCJhIjoiY2pjdHBoZGlzMnV4dDJxcGc5azJkbWRiYSJ9.o4dZRrdHcgVEKCveOXG1YQ";

const BASE="https://laminedame.github.io/Energie/";
const GEOJSON_URL=BASE+"data/Donn√©es_Bat.geojson";
const IMG_BASE=BASE+"img/";
const PDF_BASE=BASE+"pdf/";

const map=new mapboxgl.Map({
container:"map",
style:"mapbox://styles/mapbox/streets-v12",
center:[3.5617,43.58],
zoom:14
});

map.addControl(new mapboxgl.NavigationControl(),"top-right");

map.on("load",async()=>{
const geojson=await(await fetch(GEOJSON_URL)).json();

map.addSource("bat",{type:"geojson",data:geojson});
map.addLayer({
id:"points",
type:"circle",
source:"bat",
paint:{
"circle-radius":7,
"circle-color":"#d32f2f",
"circle-stroke-width":2,
"circle-stroke-color":"#fff"
}
});

map.on("click","points",e=>{
const p=e.features[0].properties;
const photo=p.photo?IMG_BASE+p.photo:"";
const pdf=(p.pdf_bat&&p.pdf_bat!="NULL")?PDF_BASE+p.pdf_bat:"";

const html=`
<div class="popup-mini">
<h3>${p.ID_bat}</h3>
${photo?`<img src="${photo}">`:""}
<div><b>Compteurs:</b><br>${p.Compteur_bati||""}</div>
${pdf?`<a href="${pdf}" target="_blank">üìÑ Fiche b√¢timent</a>`:""}
</div>`;

new mapboxgl.Popup({offset:20}).setLngLat(e.lngLat).setHTML(html).addTo(map);
});

map.on("mouseenter","points",()=>map.getCanvas().style.cursor="pointer");
map.on("mouseleave","points",()=>map.getCanvas().style.cursor="");
});

/* DRAWER */
const drawer=document.getElementById("drawer");
document.getElementById("openBilans").onclick=()=>drawer.classList.add("open");
document.getElementById("closeDrawer").onclick=()=>drawer.classList.remove("open");

const bilans={
"Vend√©mian":BASE+"pdf/bilan_vendemian.pdf"
};

const list=document.getElementById("bilansList");
Object.entries(bilans).forEach(([name,url])=>{
const b=document.createElement("button");
b.textContent=name;
b.onclick=()=>document.getElementById("pdfFrame").src=url;
list.appendChild(b);
});
</script>

</body>
</html>
